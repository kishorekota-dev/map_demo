# AI Orchestrator - Visual Architecture

## System Architecture Diagram

```
╔═══════════════════════════════════════════════════════════════════════════════════╗
║                    CHAT BANKING APPLICATION - FULL STACK                          ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              FRONTEND LAYER                                      │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│   ┌───────────────────────┐              ┌───────────────────────┐             │
│   │   Customer Portal     │              │    Agent Dashboard    │             │
│   │   (React + Vite)      │              │   (React + Socket.IO) │             │
│   │   Port: 3000          │              │   Port: 8081          │             │
│   └───────────┬───────────┘              └───────────┬───────────┘             │
│               │                                       │                          │
└───────────────┼───────────────────────────────────────┼─────────────────────────┘
                │                                       │
                └───────────────────┬───────────────────┘
                                    │
┌───────────────────────────────────▼───────────────────────────────────────────┐
│                              GATEWAY LAYER                                     │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐     │
│   │                        API Gateway                                   │     │
│   │                        Port: 3001                                    │     │
│   │  • Service Discovery    • Load Balancing    • Rate Limiting         │     │
│   │  • JWT Authentication   • Request Routing   • Health Checks         │     │
│   └──────────────────────────────────┬──────────────────────────────────┘     │
│                                       │                                         │
└───────────────────────────────────────┼─────────────────────────────────────────┘
                                        │
            ┌───────────────────────────┼────────────────────────────┐
            │                           │                            │
┌───────────▼───────────┐   ┌──────────▼──────────┐   ┌────────────▼───────────┐
│   PROCESSING LAYER    │   │  PROCESSING LAYER   │   │   PROCESSING LAYER     │
├───────────────────────┤   ├─────────────────────┤   ├────────────────────────┤
│   NLP Service         │   │   NLU Service       │   │   MCP Service          │
│   Port: 3002          │   │   Port: 3003        │   │   Port: 3004           │
│   • Text Analysis     │   │   • Intent Detection│   │   • Tool Registry      │
│   • Entity Extraction │   │   • DialogFlow      │   │   • Tool Execution     │
│   • Preprocessing     │   │   • Context Mgmt    │   │   • Banking Tools      │
└───────────┬───────────┘   └──────────┬──────────┘   └────────────┬───────────┘
            │                           │                            │
            └───────────────────────────┼────────────────────────────┘
                                        │
┌───────────────────────────────────────▼─────────────────────────────────────────┐
│                              BACKEND LAYER                                       │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐       │
│   │                     Chat Backend Service                             │       │
│   │                     Port: 3006                                       │       │
│   │  • WebSocket (Socket.IO)    • Session Management                    │       │
│   │  • Real-time Chat           • Agent Orchestration                   │       │
│   │  • Message Routing          • Conversation State                    │       │
│   └──────────────────────────────────┬──────────────────────────────────┘       │
│                                       │                                           │
└───────────────────────────────────────┼───────────────────────────────────────────┘
                                        │
┌═══════════════════════════════════════▼═══════════════════════════════════════════╗
║                       🆕 AI ORCHESTRATION LAYER 🆕                                ║
╠═══════════════════════════════════════════════════════════════════════════════════╣
║                                                                                    ║
║   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓   ║
║   ┃              AI ORCHESTRATOR SERVICE - Port: 3007                          ┃   ║
║   ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┫   ║
║   ┃                                                                             ┃   ║
║   ┃  ┌──────────────────────────────────────────────────────────────────┐    ┃   ║
║   ┃  │              REST API LAYER (7 Endpoints)                        │    ┃   ║
║   ┃  │  POST /process   POST /feedback   GET /session/:id               │    ┃   ║
║   ┃  │  GET /user/:id/sessions   POST /session   DELETE /session/:id    │    ┃   ║
║   ┃  └──────────────────────────┬───────────────────────────────────────┘    ┃   ║
║   ┃                              │                                             ┃   ║
║   ┃  ┌──────────────────────────▼───────────────────────────────────────┐    ┃   ║
║   ┃  │              WORKFLOW SERVICE LAYER                              │    ┃   ║
║   ┃  │  • processMessage()          • processHumanFeedback()            │    ┃   ║
║   ┃  │  • processConfirmation()     • processDataCollection()           │    ┃   ║
║   ┃  │  • getExecutionHistory()     • parseDataFromResponse()           │    ┃   ║
║   ┃  └──────────────────────────┬───────────────────────────────────────┘    ┃   ║
║   ┃              ┌───────────────┼───────────────┐                            ┃   ║
║   ┃              │               │               │                            ┃   ║
║   ┃    ┌─────────▼────────┐  ┌──▼────────────┐  ┌─▼───────────────┐         ┃   ║
║   ┃    │  LangGraph       │  │   Session     │  │   MCP Client    │         ┃   ║
║   ┃    │  Workflow        │  │   Manager     │  │                 │         ┃   ║
║   ┃    │                  │  │               │  │                 │         ┃   ║
║   ┃    │ ┌──────────────┐ │  │ • createSess  │  │ • executeTool   │         ┃   ║
║   ┃    │ │1. analyze    │ │  │ • getSession  │  │ • retry logic   │         ┃   ║
║   ┃    │ │   intent     │ │  │ • updateState │  │ • batch exec    │         ┃   ║
║   ┃    │ └──────┬───────┘ │  │ • collectData │  │ • banking ops   │         ┃   ║
║   ┃    │ ┌──────▼───────┐ │  │ • auto-clean  │  │                 │         ┃   ║
║   ┃    │ │2. check      │ │  │               │  │                 │         ┃   ║
║   ┃    │ │   data       │ │  └───────────────┘  └─────────────────┘         ┃   ║
║   ┃    │ └──────┬───────┘ │                                                  ┃   ║
║   ┃    │ ┌──────▼───────┐ │  ┌─────────────────────────────────────┐        ┃   ║
║   ┃    │ │3. request    │ │  │     Intent-Based Prompts            │        ┃   ║
║   ┃    │ │   input      │ │  │  • balance_inquiry                  │        ┃   ║
║   ┃    │ └──────┬───────┘ │  │  • transaction_history              │        ┃   ║
║   ┃    │ ┌──────▼───────┐ │  │  • transfer_funds                   │        ┃   ║
║   ┃    │ │4. execute    │ │  │  • card_management                  │        ┃   ║
║   ┃    │ │   tools      │ │  │  • dispute_transaction              │        ┃   ║
║   ┃    │ └──────┬───────┘ │  │  • account_info                     │        ┃   ║
║   ┃    │ ┌──────▼───────┐ │  │  • general_inquiry                  │        ┃   ║
║   ┃    │ │5. generate   │ │  └─────────────────────────────────────┘        ┃   ║
║   ┃    │ │   response   │ │                                                  ┃   ║
║   ┃    │ └──────┬───────┘ │  ┌─────────────────────────────────────┐        ┃   ║
║   ┃    │ ┌──────▼───────┐ │  │       OpenAI GPT-4 Integration      │        ┃   ║
║   ┃    │ │6. confirm    │ │  │  • Model: gpt-4                     │        ┃   ║
║   ┃    │ │              │ │  │  • Temperature: 0.7                 │        ┃   ║
║   ┃    │ └──────┬───────┘ │  │  • Max Tokens: 1000                 │        ┃   ║
║   ┃    │ ┌──────▼───────┐ │  │  • Context-aware responses          │        ┃   ║
║   ┃    │ │7. handle     │ │  └─────────────────────────────────────┘        ┃   ║
║   ┃    │ │   error      │ │                                                  ┃   ║
║   ┃    │ └──────────────┘ │                                                  ┃   ║
║   ┃    └──────────────────┘                                                  ┃   ║
║   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛   ║
║                                       │                                          ║
╚═══════════════════════════════════════▼══════════════════════════════════════════╝
                                        │
            ┌───────────────────────────┼────────────────────────────┐
            │                           │                            │
┌───────────▼───────────┐   ┌──────────▼──────────┐   ┌────────────▼───────────┐
│    DOMAIN LAYER       │   │   PERSISTENCE       │   │   TOOL EXECUTION       │
├───────────────────────┤   ├─────────────────────┤   ├────────────────────────┤
│  Banking Service      │   │  PostgreSQL DB      │   │  MCP Service (3004)    │
│  Port: 3005           │   │  Port: 5432         │   │  • Banking Tools       │
│  • Account Mgmt       │   │  ┌────────────────┐ │   │  • Transaction Tools   │
│  • Transactions       │   │  │ sessions       │ │   │  • Card Tools          │
│  • Card Services      │   │  │ executions     │ │   │  • Dispute Tools       │
│  • Fraud Detection    │   │  │ feedbacks      │ │   │  • Tool Registry       │
│  • Dispute Mgmt       │   │  └────────────────┘ │   └────────────────────────┘
└───────────────────────┘   └─────────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                           WORKFLOW EXECUTION FLOW                                 ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

User Message → Chat Backend (3006) → AI Orchestrator (3007)
                                            │
                                            ▼
                                    1. Create Session
                                    2. Analyze Intent
                                    3. Check Required Data
                                            │
                                     ┌──────┴──────┐
                                     │ Data Missing?│
                                     └──────┬──────┘
                                            │
                        ┌───────────────────┼───────────────────┐
                        │                   │                   │
                      [YES]               [NO]              [ERROR]
                        │                   │                   │
                        ▼                   ▼                   ▼
              4. Request Input    5. Execute Tools    7. Handle Error
              Human-in-Loop       via MCP (3004)      Generate Fallback
                        │                   │                   │
                        ▼                   ▼                   │
              Wait for Feedback   6. Generate Response          │
                        │                   │                   │
                        │                   └───────────────────┴───────┐
                        │                                               │
                        └───────────────────┬───────────────────────────┘
                                            ▼
                                    Return to Chat Backend
                                            ▼
                                    Display to User

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                            DATA FLOW DIAGRAM                                      ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌─────────────┐   (1) Chat Message   ┌──────────────────┐
│   Customer  │ ──────────────────────>│  Chat Backend   │
│   (3000)    │                        │     (3006)      │
└─────────────┘                        └────────┬─────────┘
                                                │
                                                │ (2) Process Request
                                                ▼
                                       ┌────────────────────┐
                                       │  AI Orchestrator   │
                                       │      (3007)        │
                                       └─────┬──────────────┘
                                             │
                         ┌───────────────────┼───────────────────┐
                         │                   │                   │
                  (3) Intent          (4) Session         (5) Tools
                  Prompts             PostgreSQL           MCP Service
                         │                   │                   │
                         ▼                   ▼                   ▼
                  ┌──────────┐       ┌──────────┐       ┌──────────┐
                  │ Prompt   │       │ Session  │       │ Banking  │
                  │ Template │       │ State    │       │ Tools    │
                  └──────────┘       └──────────┘       └──────────┘
                         │                   │                   │
                         └───────────────────┼───────────────────┘
                                             │
                                    (6) GPT-4 Processing
                                             │
                                             ▼
                                       ┌──────────┐
                                       │  OpenAI  │
                                       │  GPT-4   │
                                       └──────┬───┘
                                             │
                                    (7) AI Response
                                             │
                                             ▼
                                       ┌────────────────────┐
                                       │  AI Orchestrator   │
                                       │      (3007)        │
                                       └─────┬──────────────┘
                                             │
                                    (8) Formatted Response
                                             │
┌─────────────┐   (9) Display     ┌──────────▼──────┐
│   Customer  │ <─────────────────│  Chat Backend   │
│   (3000)    │      Response     │     (3006)      │
└─────────────┘                   └─────────────────┘

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                         SERVICE COMMUNICATION PORTS                               ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

Frontend (3000) ───┐
Agent UI (8081) ───┼──> API Gateway (3001)
                   │         │
                   │         ├──> NLP Service (3002)
                   │         ├──> NLU Service (3003)
                   │         ├──> MCP Service (3004)
                   │         ├──> Banking Service (3005)
                   │         ├──> Chat Backend (3006)
                   │         └──> 🆕 AI Orchestrator (3007)
                   │                     │
                   │                     ├──> PostgreSQL (5432)
                   │                     ├──> OpenAI GPT-4 API
                   │                     └──> MCP Service (3004)
                   │
                   └──> Chat Backend (3006) ───> AI Orchestrator (3007)

╔═══════════════════════════════════════════════════════════════════════════════════╗
║                         HUMAN-IN-THE-LOOP FLOW                                    ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

┌──────────────┐
│ User Query:  │
│ "Balance?"   │
└──────┬───────┘
       │
       ▼
┌──────────────────────────┐
│ AI Orchestrator          │
│ 1. Analyze Intent        │
│    → balance_inquiry     │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│ 2. Check Required Data   │
│    → account_id missing  │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│ 3. Request Human Input   │
│    "Which account?"      │
└──────┬───────────────────┘
       │
       ▼
┌──────────────┐
│ User Reply:  │
│ "Savings"    │
└──────┬───────┘
       │
       ▼
┌──────────────────────────┐
│ 4. Process Feedback      │
│    → Parse account_id    │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│ 5. Execute Tools         │
│    → get_account_balance │
└──────┬───────────────────┘
       │
       ▼
┌──────────────────────────┐
│ 6. Generate Response     │
│    "Balance: $5,234.50"  │
└──────┬───────────────────┘
       │
       ▼
┌──────────────┐
│ Display to   │
│ Customer     │
└──────────────┘
```
